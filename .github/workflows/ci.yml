name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install
        run: npm install

      - name: Lint workflows
        run: npm run lint:workflows

      - name: Check
        run: npm run check

  e2e-smoke:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm install

      - name: Build
        run: npm run build

      - name: Install Playwright (Chromium)
        run: |
          if [[ "${RUNNER_OS}" == "Linux" ]]; then
            npx playwright install chromium
          else
            npx playwright install chromium
          fi

      - name: E2E smoke
        run: npm run e2e:smoke

  gitleaks:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Install Gitleaks
        run: |
          GOBIN="${RUNNER_TEMP}/bin" go install github.com/zricethezav/gitleaks/v8@v8.28.0
          echo "${RUNNER_TEMP}/bin" >> "${GITHUB_PATH}"
      - name: Gitleaks
        run: gitleaks git --redact --no-banner --verbose

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
